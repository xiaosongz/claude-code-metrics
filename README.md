# Claude Code Metrics

A centralized monitoring solution for tracking Claude Code usage across multiple environments. This system collects metrics from distributed Claude Code installations and visualizes them using Prometheus and Grafana.

![License](https://img.shields.io/badge/license-MIT-blue.svg)
![Docker](https://img.shields.io/badge/docker-ready-brightgreen.svg)
![Platform](https://img.shields.io/badge/platform-linux%20%7C%20macos%20%7C%20windows-lightgrey.svg)

## Features

- Real-time usage tracking across multiple environments
- Cost monitoring by client and environment
- Session tracking and token usage analytics
- Environment and client identification
- Easy deployment with Docker Compose
- Privacy-focused configuration options
- Cross-platform support (Linux, macOS, Windows)
- Pre-built Grafana dashboards
- OpenTelemetry-based architecture

## Architecture

```
                                                          
 Claude Code        OTLP/gRPC        OpenTelemetry      
 (Client 1)        ------------->    Collector          
                                           |              
                                           |              
                                           v
 Claude Code                                              
 (Client 2)        ------------->    Prometheus         
                    Remote Write           |              
                                           |              
                                           v
                                                            
                                        Grafana            
                                        (Dashboards)       
                                                            
```

## Quick Start

For detailed platform-specific instructions, see the [**Complete Setup Guide**](./SETUP_GUIDE.md).

### Server Setup

#### Linux/macOS
```bash
# Clone repository
git clone https://github.com/xiaosongz/claude-code-metrics.git
cd claude-code-metrics

# Run automated setup
./server-setup.sh

# Access Grafana at http://localhost:3000
```

#### Windows
```powershell
# Clone repository
git clone https://github.com/xiaosongz/claude-code-metrics.git
cd claude-code-metrics

# Run PowerShell setup script
.\server-setup.ps1

# Access Grafana at http://localhost:3000
```

### Client Setup

#### Linux/macOS
```bash
cd client
./setup.sh
source claude-metrics.env
claude-code  # Now sends metrics
```

#### Windows
```powershell
cd client
.\setup.ps1
. .\claude-metrics.ps1
claude-code  # Now sends metrics
```

## Metrics Collected

Claude Code exports the following metrics:

- **Session Metrics**
  - `claude_code_session_count`: Number of sessions
  - `claude_code_active_time_seconds`: Active development time

- **Code Metrics**
  - `claude_code_lines_of_code`: Lines of code written/modified
  - `claude_code_git_commit_count`: Git commits created
  - `claude_code_pull_request_count`: Pull requests created

- **Cost Metrics**
  - `claude_code_api_usage_cost_usd`: API usage costs
  - Token usage by model type

- **Tool Usage**
  - Tool execution counts and performance

## Requirements

### Server Requirements
- Docker and Docker Compose
- 2GB RAM minimum (4GB recommended)
- 10GB free disk space
- Ports: 3000 (Grafana), 4317 (OTLP), 9090 (Prometheus)

### Client Requirements
- Claude Code CLI installed
- Network access to server port 4317

### Supported Platforms
- **Linux**: Ubuntu 20.04+, Debian 10+, RHEL 8+
- **macOS**: 10.15 (Catalina) or later
- **Windows**: 10 Pro/Enterprise (Build 19041+) or Windows 11 with WSL2

## Configuration

### Server Configuration

The server uses environment variables configured in `.env`:

```bash
GRAFANA_USER=admin
GRAFANA_PASSWORD=<auto-generated>
PROMETHEUS_RETENTION_TIME=90d
PROMETHEUS_RETENTION_SIZE=10GB
```

See [docker-compose.yml](./docker-compose.yml) for full configuration options.

### Client Configuration

Environment variables for metric collection:

```bash
# Required
CLAUDE_CODE_ENABLE_TELEMETRY=1
OTEL_EXPORTER_OTLP_ENDPOINT=http://server:4317

# Optional
OTEL_METRIC_EXPORT_INTERVAL=30000  # 30 seconds
OTEL_METRICS_INCLUDE_SESSION_ID=false  # Privacy
CLAUDE_ENV=dev  # Environment name
CLAUDE_CLIENT_ID=my-machine  # Client identifier
```

## Grafana Dashboards

The system includes pre-configured dashboards:

1. **Overview Dashboard**
   - Session rate by environment
   - Total cost by environment
   - Lines of code by client
   - Git activity timeline
   - Client summary table

2. **Custom Dashboards**
   - Create your own at http://localhost:3000
   - Use Prometheus as the data source
   - All metrics prefixed with `claude_code_`

## Documentation

- [**Complete Setup Guide**](./SETUP_GUIDE.md) - Detailed platform-specific instructions
- [**CLAUDE.md**](./CLAUDE.md) - Development notes for Claude Code instances
- [**Architecture Overview**](./docker-compose.yml) - Service configuration details

## Troubleshooting

### Common Issues

1. **No metrics appearing**
   - Verify telemetry is enabled: `echo $CLAUDE_CODE_ENABLE_TELEMETRY`
   - Check connectivity to server port 4317
   - Review Docker logs: `docker-compose logs -f`

2. **Port conflicts**
   - Change ports in `docker-compose.yml` and `.env`
   - Check for existing services using the ports

3. **High memory usage**
   - Adjust Prometheus retention in `docker-compose.yml`
   - Configure data downsampling

For platform-specific issues, see the [troubleshooting section](./SETUP_GUIDE.md#troubleshooting) in the setup guide.

## Security Considerations

1. **Authentication**: Enable Grafana authentication in production
2. **Network**: Use HTTPS/TLS for remote connections
3. **Privacy**: Configure which metrics to include/exclude
4. **Access Control**: Restrict OTLP endpoint access

## Advanced Usage

### Multi-Region Setup
Use the OpenTelemetry Collector to route metrics to region-specific Prometheus instances.

### Alerting
Configure Prometheus alerts for:
- High costs
- Unusual activity
- System errors

### Integration
Export metrics to:
- Datadog
- New Relic
- CloudWatch
- Custom backends

## Project Structure

```
claude-code-metrics/
├── docker-compose.yml          # Service orchestration
├── server-setup.sh            # Linux/macOS server setup
├── server-setup.ps1           # Windows server setup
├── .env.example               # Environment template
├── SETUP_GUIDE.md            # Detailed setup instructions
├── CLAUDE.md                 # Claude Code dev notes
├── client/
│   ├── setup.sh              # Linux/macOS client setup
│   ├── setup.ps1             # Windows client setup
│   └── claude-with-metrics   # Wrapper script
└── server/
    ├── otel-collector-config.yml
    ├── prometheus/
    │   └── prometheus.yml
    └── grafana/
        ├── dashboards/
        └── datasources/
```

## Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## Support

- **Issues**: [GitHub Issues](https://github.com/xiaosongz/claude-code-metrics/issues)
- **Documentation**: [Setup Guide](./SETUP_GUIDE.md)
- **Claude Code**: [Official Documentation](https://docs.anthropic.com/en/docs/claude-code)

## License

MIT License - See [LICENSE](./LICENSE) file for details

## Acknowledgments

- Built with [OpenTelemetry](https://opentelemetry.io/)
- Powered by [Prometheus](https://prometheus.io/) and [Grafana](https://grafana.com/)
- Designed for [Claude Code](https://claude.ai/code) by Anthropic